<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Redirigiendo a WhatsApp...</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #25d366;
    }
    .box {
      background: #fff;
      padding: 24px 32px;
      border-radius: 16px;
      max-width: 360px;
      text-align: center;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #075e54;
    }
    p {
      margin: 0 0 12px;
      font-size: 14px;
      color: #555;
    }
    .status {
      font-size: 13px;
      color: #777;
      margin-top: 8px;
    }
    #fallback {
      display: none;
      margin-top: 16px;
    }
    #fallback a {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 999px;
      background: #25d366;
      color: #fff;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>Conectando con WhatsApp…</h1>
    <p>En unos segundos se abrirá el chat.</p>
    <div class="status" id="status">Preparando conexión…</div>
    <div id="fallback">
      <a id="manualLink" href="#" target="_blank">Abrir WhatsApp manualmente</a>
    </div>
  </div>

  <script>
    const CONFIG = {
      whatsappNumber: "525546242327", // sin +
      scriptURL:
        "https://script.google.com/macros/s/AKfycbxZuHpSgUgGaZ7M_DgAhye5liuG40LQuX0BMRB1rPZfgRHGrTVYzRSXKJdJUuYQcyKa/exec",
      mensaje: "Hola! Me interesa recibir INFO",
      redirectDelay: 2000,
      debug: false,
    };

    const statusEl = document.getElementById("status");
    const fallbackEl = document.getElementById("fallback");
    const manualLinkEl = document.getElementById("manualLink");
    const urlParams = new URLSearchParams(window.location.search);

    function updateStatus(msg, isError) {
      statusEl.textContent = msg;
      if (isError) statusEl.style.color = "#c62828";
    }

    // Datos capturados
    const capturedData = {
      fbclid: urlParams.get("fbclid"),
      campaign_id: urlParams.get("campaign_id"),
      adset_id: urlParams.get("adset_id"),
      ad_id: urlParams.get("ad_id"),
      utm_source: urlParams.get("utm_source"),
      utm_medium: urlParams.get("utm_medium"),
      utm_campaign: urlParams.get("utm_campaign"),
      user_agent: navigator.userAgent,
      referrer: document.referrer,
      timestamp: new Date().toISOString(),
      page_url: window.location.href,
    };

    // fbc (si no hay fbclid, generamos uno genérico)
    if (capturedData.fbclid) {
      const ts = Math.floor(Date.now() / 1000);
      capturedData.fbc = fb.1.${ts}.${capturedData.fbclid};
    } else {
      const ts = Math.floor(Date.now() / 1000);
      capturedData.fbc = `fb.1.${ts}.NO_FBCLID_${Math.random()
        .toString(36)
        .substring(2, 8)}`;
      updateStatus("Advertencia: no se detectó fbclid (prueba sin anuncio)", true);
    }

    // fbp
    capturedData.fbp = `fb.1.${Math.floor(Date.now() / 1000)}.${Math.random()
      .toString(36)
      .substring(2, 15)}`;

    // session_id
    capturedData.session_id = `sess_${Date.now()}_${Math.random()
      .toString(36)
      .substring(2, 8)}`;

    // URL de WhatsApp
    const mensajeID = ${CONFIG.mensaje}\n\nID:${capturedData.session_id};
    const whatsappURL = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(
      mensajeID
    )}`;
    manualLinkEl.href = whatsappURL;

    // Enviar a Google Script y luego redirigir
    function goWhatsApp() {
      updateStatus("Abriendo WhatsApp…");
      window.location.href = whatsappURL;
    }

    if (
      CONFIG.scriptURL &&
      CONFIG.scriptURL.indexOf("script.google.com") !== -1
    ) {
      updateStatus("Guardando información de seguimiento…");
      fetch(CONFIG.scriptURL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(capturedData),
      })
        .catch((e) => {
          // aunque falle, redirigimos igual
          console.error(e);
        })
        .finally(() => {
          setTimeout(goWhatsApp, CONFIG.redirectDelay);
        });
    } else {
      updateStatus("Configuración pendiente. Redirigiendo…");
      setTimeout(goWhatsApp, CONFIG.redirectDelay);
    }

    // Mostrar botón manual por si falla la redirección
    setTimeout(() => {
      fallbackEl.style.display = "block";
    }, CONFIG.redirectDelay + 3000);
  </script>
</body>
</html>
