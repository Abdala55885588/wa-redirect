<script>
const CONFIG = {
    whatsappNumber: '525546242327',
    scriptURL: 'https://script.google.com/macros/s/AKfycbxZuHpSgUgGaZ7M_DgAhye5liuG40LQuX0BMRB1rPZfgRHGrTVYzRSXKJdJUuYQcyKa/exec',
    mensaje: "Hola! Me interesa recibir INFO",
    redirectDelay: 2000,
    debug: false
};

const urlParams = new URLSearchParams(window.location.search);
const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');
const fallbackEl = document.getElementById('fallback');
const manualLinkEl = document.getElementById('manualLink');

function updateStatus(message, isError = false) {
    statusEl.textContent = message;
    if (isError) statusEl.style.color = '#d32f2f';
    if (CONFIG.debug) {
        debugEl.style.display = 'block';
        const time = new Date().toLocaleTimeString();
        debugEl.innerHTML += <div><strong>${time}:</strong> ${message}</div>;
    }
}

// CAPTURAR PARÁMETROS
const capturedData = {
    fbclid: urlParams.get('fbclid'),
    campaign_id: urlParams.get('campaign_id'),
    adset_id: urlParams.get('adset_id'),
    ad_id: urlParams.get('ad_id'),
    utm_source: urlParams.get('utm_source'),
    utm_medium: urlParams.get('utm_medium'),
    utm_campaign: urlParams.get('utm_campaign'),
    user_agent: navigator.userAgent,
    referrer: document.referrer,
    timestamp: new Date().toISOString(),
    page_url: window.location.href
};

// GENERAR FBC SI HAY FBCLID, SINO CREAR UNO FALSO
if (capturedData.fbclid) {
    const ts = Math.floor(Date.now() / 1000);
    capturedData.fbc = fb.1.${ts}.${capturedData.fbclid};
} else {
    capturedData.fbc = fb.1.${Math.floor(Date.now()/1000)}.NO_FBCLID_${Math.random().toString(36).substring(2,8)};
    updateStatus('Advertencia: No se detectó fbclid', true);
}

// GENERAR FBP
capturedData.fbp = fb.1.${Math.floor(Date.now()/1000)}.${Math.random().toString(36).substring(2,15)};

// GENERAR SESSION ID CORRECTO
capturedData.session_id = sess_${Date.now()}_${Math.random().toString(36).substring(2,8)};

// MOSTRAR DEBUG
if (CONFIG.debug) {
    debugEl.innerHTML = <strong>Datos capturados:</strong><pre>${JSON.stringify(capturedData, null, 2)}</pre>;
}

// URL DE WHATSAPP
const mensajeID = ${CONFIG.mensaje}\n\nID:${capturedData.session_id};
const whatsappURL = https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(mensajeID)};
manualLinkEl.href = whatsappURL;

// ENVIAR A GOOGLE SHEET
if (CONFIG.scriptURL.includes('script.google.com')) {
    updateStatus('Guardando información de seguimiento...');
    fetch(CONFIG.scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(capturedData)
    })
    .finally(() => {
        updateStatus('Redirigiendo a WhatsApp...');
        setTimeout(() => window.location.href = whatsappURL, CONFIG.redirectDelay);
    });
} else {
    updateStatus('Configuración pendiente. Redirigiendo...');
    setTimeout(() => window.location.href = whatsappURL, CONFIG.redirectDelay);
}

// MOSTRAR LINK MANUAL SI NO REDIRIGE
setTimeout(() => {
    fallbackEl.style.display = 'block';
    updateStatus('¿No se abrió WhatsApp? Usa el botón de abajo');
}, CONFIG.redirectDelay + 3000);
</script>
