<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>Conectando con WhatsApp...</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background:linear-gradient(135deg,#25D366 0%,#128C7E 100%);padding:20px;}
.container{text-align:center;max-width:400px;background:rgba(255,255,255,0.95);padding:50px 40px;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,0.3);}
.loader{border:4px solid #e0e0e0;border-top:4px solid #25D366;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.fallback-link{display:none;margin-top:30px;}
.fallback-link a{display:inline-block;background:#25D366;color:white;padding:15px 30px;border-radius:30px;text-decoration:none;font-weight:600;transition:all .3s ease;}
.fallback-link a:hover{background:#128C7E;transform:translateY(-2px);box-shadow:0 5px 15px rgba(37,211,102,0.4);}
.status{font-size:14px;color:#666;margin-top:20px;}
</style>
</head>

<body>
<div class="container">
    <h1>Conectando con WhatsApp</h1>
    <p>Serás redirigido en un momento...</p>
    <div class="loader"></div>
    <div class="status" id="status">Preparando conexión...</div>
    <div class="fallback-link" id="fallback"><a id="manualLink" href="#">Abrir WhatsApp manualmente</a></div>
</div>

<script>
// ===== CONFIGURACIÓN =========================
const CONFIG = {
    whatsappNumber: '525546242327', // SIN +
    scriptURL: 'TU_URL_DE_APP_SCRIPT_AQUI',
    mensaje: "Hola! Me interesa recibir INFO",
    redirectDelay: 2000
};

// ===== CAPTURA DE DATOS ======================
const urlParams = new URLSearchParams(window.location.search);
const capturedData = {
    fbclid: urlParams.get('fbclid'),
    campaign_id: urlParams.get('campaign_id'),
    adset_id: urlParams.get('adset_id'),
    ad_id: urlParams.get('ad_id'),
    user_agent: navigator.userAgent,
    referrer: document.referrer,
    timestamp: new Date().toISOString(),
    page_url: window.location.href
};

// ===== GENERAR fbc SI EXISTE fbclid ===========
if (capturedData.fbclid) {
    const ts = Math.floor(Date.now()/1000);
    capturedData.fbc = fb.1.${ts}.${capturedData.fbclid};
}

// ===== GENERAR fbp ============================
const ts2 = Math.floor(Date.now()/1000);
const rnd = Math.random().toString(36).substring(2,15);
capturedData.fbp = fb.1.${ts2}.${rnd};

// ===== session_id ============================
capturedData.session_id = sess_${Date.now()}_${Math.random().toString(36).substring(2,8)};

// ===== URL DE WHATSAPP =======================
const mensajeFinal = CONFIG.mensaje + "\n\nID:" + capturedData.session_id;
const waURL = https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(mensajeFinal)};
document.getElementById("manualLink").href = waURL;

// ===== ENVIAR a GOOGLE SHEET ==================
fetch(CONFIG.scriptURL, {
    method: "POST",
    mode: "no-cors",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(capturedData)
})
.then(()=>redir())
.catch(()=>redir());

// ===== REDIRECCIÓN ============================
function redir(){
    document.getElementById("status").textContent="Abriendo WhatsApp...";
    setTimeout(()=>window.location.href = waURL, CONFIG.redirectDelay);
}

// ===== FALLBACK MANUAL ========================
setTimeout(()=>{
    document.getElementById("fallback").style.display="block";
    document.getElementById("status").textContent="¿No se abrió WhatsApp? Usa el botón de abajo";
}, CONFIG.redirectDelay + 3000);
</script>
</body>
</html>
